name: Check document generation

on:
  push:
    branches:
    - asf-site
  pull_request:
    branches:
    - asf-site

jobs:
  lint:
    name: check whether all documentation was generated with the right Jekyll version
    runs-on: ubuntu-20.04
    container:
      image: dongjoon/apache-spark-github-action-image:20201025
    steps:
    - name: Free up disk space
      shell: 'script -q -e -c "bash {0}"'
      run: |
        echo "=================================="
        echo "Free up disk space on CI system"
        echo "=================================="

        echo "Listing top 100 largest packages (from large to small)"
        printf "Installed-Size\tPackage\n"
        dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n -r | head -n 100
        df -h

        echo "Removing large packages"
        rm -rf /__t/CodeQL
        rm -rf /__t/go
        rm -rf /__t/node

        apt-get remove --purge -y '^aspnet.*' || true
        apt-get remove --purge -y '^dotnet-.*' || true
        apt-get remove --purge -y '^llvm-.*' || true
        apt-get remove --purge -y 'php.*' || true
        apt-get remove --purge -y '^mongodb-.*' || true
        apt-get remove --purge -y 'gfortran-11' || true
        apt-get remove --purge -y 'humanity-icon-theme' || true
        apt-get remove --purge -y 'nodejs-doc' || true
        apt-get remove --purge -y snapd google-chrome-stable microsoft-edge-stable firefox || true
        apt-get remove --purge -y azure-cli google-cloud-sdk mono-devel powershell libgl1-mesa-dri || true
        apt-get autoremove --purge -y
        apt-get clean

        df -h
    - name: Checkout Spark Website repository
      uses: actions/checkout@v2
    - name: Install dependencies for documentation generation
      run: |
        apt-get update -y
        apt-get install -y ruby ruby-dev
        gem install bundler --version 2.4.19
        bundle install
    - name: Run documentation build
      run: |
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        OLD_IFS=$IFS
        IFS=
        GEN_ERRORS=$(bundle exec jekyll build 3>&2 2>&1 1>&3)
        if [ $(echo $GEN_ERRORS| grep -v -e '^$'| grep -c -v "rubygems_integration") -ne 0 ]; then
          echo "Error during document generation:"
          echo $GEN_ERRORS
          exit 1
        fi
        IFS=$OLD_IFS
        CHANGED_FILE=( $(git ls-files --modified --other --exclude-standard --directory | grep -v sitemap.xml) )
        if [ ${#CHANGED_FILE[@]} -ne 0 ]; then
          echo "Not all documentation was generated and/or not the right Jekyll version was used! Modified / untracked files (excluding sitemap.xml):"
          echo ${CHANGED_FILE[*]}
          echo "Git diff (excluding sitemap.xml):"
          git diff -- . ':(exclude)site/sitemap.xml'
          exit 1
        fi
      shell: /bin/bash {0}
